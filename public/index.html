<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Article Cloner - LP自動クローン</title>
<link rel="stylesheet" href="/css/app.css">
<link rel="stylesheet" href="/css/editor.css">
</head>
<body>

<!-- 画面1: URL入力 -->
<div id="screen-landing" class="screen active">
  <div class="landing-bg"></div>
  <div class="landing-content">
    <div class="landing-logo">
      <svg width="40" height="40" viewBox="0 0 40 40" fill="none">
        <rect width="40" height="40" rx="10" fill="url(#g1)"/>
        <path d="M12 14h16v2H12zm0 5h12v2H12zm0 5h14v2H12z" fill="#fff" opacity="0.9"/>
        <defs><linearGradient id="g1" x1="0" y1="0" x2="40" y2="40"><stop stop-color="#ec4899"/><stop offset="1" stop-color="#f472b6"/></linearGradient></defs>
      </svg>
      <h1>Article Cloner</h1>
    </div>
    <p class="landing-subtitle">競合LPをスクレイプ → ブロック編集 → Squad Beyond互換HTMLを出力</p>
    <div class="url-input-card">
      <div class="url-input-wrapper">
        <svg class="url-icon" width="20" height="20" viewBox="0 0 20 20" fill="none">
          <path d="M8.5 13.5l-1.414 1.414a3 3 0 01-4.243-4.243l3-3a3 3 0 014.243 0M11.5 6.5l1.414-1.414a3 3 0 014.243 4.243l-3 3a3 3 0 01-4.243 0" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
        </svg>
        <input type="url" id="url-input" placeholder="クローンしたいLPのURLをペースト..." autocomplete="off" spellcheck="false">
        <button id="btn-start" class="btn-primary" disabled>
          <span>クローン開始</span>
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 8h10m-4-4l4 4-4 4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        </button>
      </div>
    </div>
    <div class="landing-features">
      <div class="feature-chip"><span class="feature-dot" style="background:#ec4899"></span>自動スクレイプ</div>
      <div class="feature-chip"><span class="feature-dot" style="background:#f472b6"></span>ブロック編集</div>
      <div class="feature-chip"><span class="feature-dot" style="background:#db2777"></span>AI画像生成</div>
      <div class="feature-chip"><span class="feature-dot" style="background:#10B981"></span>SB互換出力</div>
    </div>
    <!-- Gemini APIキー設定カード -->
    <div class="api-key-card" id="api-key-card">
      <div class="api-key-header">
        <div class="api-key-status" id="api-key-status">
          <span class="status-dot"></span>
          <span class="api-key-status-text">確認中...</span>
        </div>
        <span class="api-key-label">Gemini API</span>
      </div>
      <div class="api-key-body" id="api-key-body">
        <p class="api-key-desc">AI画像生成・テキスト書き換えに必要です。<a href="https://aistudio.google.com/apikey" target="_blank" rel="noopener" class="api-key-link">Google AI Studio</a> で無料で取得できます。</p>
        <div class="api-key-input-row">
          <input type="password" id="api-key-input" class="api-key-input" placeholder="APIキーをペースト..." autocomplete="off" spellcheck="false">
          <button id="btn-save-key" class="btn-save-key">保存</button>
        </div>
        <div class="api-key-hint" id="api-key-hint"></div>
      </div>
    </div>

    <!-- 保存済みプロジェクト一覧 -->
    <div id="saved-project-list" class="saved-project-list" style="display:none"></div>

    <div class="landing-footer">
      <span class="footer-version">v1.2.0</span>
    </div>
  </div>
</div>

<!-- セットアップガイドモーダル -->
<div id="modal-setup" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content modal-lg">
    <div class="modal-header">
      <h3>セットアップガイド</h3>
      <button class="modal-close" data-close-modal="modal-setup">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="setup-section">
        <h4>1. Gemini APIキーの設定</h4>
        <p>AI画像生成・テキスト書き換え機能に必要です。</p>
        <div class="setup-code">
          <code># .env ファイルを編集<br>
GEMINI_API_KEY_1=your_key_here<br><br>
# キーの取得先:<br>
# https://aistudio.google.com/apikey</code>
        </div>
      </div>
      <div class="setup-section">
        <h4>2. 使い方</h4>
        <ol class="setup-steps">
          <li>クローンしたいLPのURLを入力</li>
          <li>自動スクレイプ → ブロック分解</li>
          <li>各ブロックをクリックして編集（手動 or AI）</li>
          <li>テキスト一括差し替えで商品名・URL変更</li>
          <li>ビルド → SB互換HTMLをダウンロード</li>
        </ol>
      </div>
      <div class="setup-section">
        <h4>3. AI編集モード</h4>
        <p>テキストブロック選択時に「AI編集」タブを使うと、Gemini APIで自動書き換えできます。</p>
        <ul class="setup-list">
          <li>「トンマナを変えて大人っぽく」</li>
          <li>「煽りを強めて」</li>
          <li>「別商品に差し替えて」</li>
        </ul>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-primary" data-close-modal="modal-setup">閉じる</button>
    </div>
  </div>
</div>

<!-- 画面2: スクレイプ進捗 -->
<div id="screen-loading" class="screen">
  <div class="loading-content">
    <h2 class="loading-title">クローン処理中...</h2>
    <p class="loading-url" id="loading-url"></p>
    <div class="progress-segments">
      <div class="segment" id="seg-scrape">
        <div class="segment-bar"><div class="segment-fill"></div></div>
        <span class="segment-label">取得</span>
      </div>
      <div class="segment-arrow">&rarr;</div>
      <div class="segment" id="seg-parse">
        <div class="segment-bar"><div class="segment-fill"></div></div>
        <span class="segment-label">解析</span>
      </div>
      <div class="segment-arrow">&rarr;</div>
      <div class="segment" id="seg-ready">
        <div class="segment-bar"><div class="segment-fill"></div></div>
        <span class="segment-label">完了</span>
      </div>
    </div>
    <div class="live-counters">
      <div class="counter-item">
        <span class="counter-value" id="counter-assets">-</span>
        <span class="counter-label">アセット</span>
      </div>
      <div class="counter-item">
        <span class="counter-value" id="counter-blocks">-</span>
        <span class="counter-label">ブロック</span>
      </div>
      <div class="counter-item">
        <span class="counter-value" id="counter-sections">-</span>
        <span class="counter-label">セクション</span>
      </div>
    </div>
    <div class="log-panel" id="log-panel">
      <div class="log-entries" id="log-entries"></div>
    </div>
  </div>
</div>

<!-- 画面3: メインエディタ -->
<div id="screen-editor" class="screen">
  <div class="editor-toolbar">
    <div class="toolbar-left">
      <button class="toolbar-btn" id="btn-back" title="戻る">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M10 3L5 8l5 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
      </button>
      <span class="toolbar-title" id="toolbar-title">エディタ</span>
      <span class="toolbar-badge" id="toolbar-block-count"></span>
    </div>
    <div class="toolbar-center">
      <button class="toolbar-btn" id="btn-refresh" title="プレビュー更新">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 8a6 6 0 0111.5-2.3M14 8a6 6 0 01-11.5 2.3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/><path d="M13 2v4h-4M3 14v-4h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>更新</span>
      </button>
      <button class="toolbar-btn" id="btn-undo" title="元に戻す (Ctrl+Z)" disabled>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 8h8a3 3 0 010 6H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 5L3 8l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>戻す</span>
      </button>
      <button class="toolbar-btn" id="btn-redo" title="やり直し (Ctrl+Y)" disabled>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M13 8H5a3 3 0 000 6h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 5l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>進む</span>
      </button>
      <button class="toolbar-btn" id="btn-add-block" title="ブロック追加">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>+ブロック</span>
      </button>
      <button class="toolbar-btn" id="btn-upload-image" title="画像アップロード">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 10V2m-3 3l3-3 3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M2 10v3h12v-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>画像UP</span>
      </button>
      <button class="toolbar-btn" id="btn-text-modify" title="一括テキスト差し替え">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M2 8h8M2 12h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>リンク差替</span>
      </button>
      <button class="toolbar-btn" id="btn-open-widgets" title="ウィジェット挿入">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>Widget</span>
      </button>
    </div>
    <div class="toolbar-right">
      <button class="toolbar-btn" id="btn-tag-settings" title="タグ設定">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 3h10v2H3zM5 7h6v2H5zM4 11h8v2H4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>タグ設定</span>
      </button>
      <button class="toolbar-btn" id="btn-exit-popup" title="離脱ポップアップ">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M3 3h10v10H3z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M6 8h4M8 6v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>離脱POP</span>
      </button>
      <button class="toolbar-btn" id="btn-history" title="変更履歴">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 4v4l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5"/></svg>
        <span>履歴</span>
      </button>
      <button class="toolbar-btn" id="btn-viewport" title="プレビュー幅切替">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="3" y="2" width="10" height="12" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M6 12h4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
        <span>412px</span>
      </button>
      <button class="toolbar-btn btn-accent" id="btn-build" title="SB互換HTMLを生成">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M4 8l3 3 5-6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>ビルド</span>
      </button>
      <button class="toolbar-btn" id="btn-export" title="HTMLをダウンロード" disabled>
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2v8m-3-3l3 3 3-3M3 12v1h10v-1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>書き出し</span>
      </button>
      <button class="toolbar-btn btn-accent" id="btn-publish" title="Cloudflare Pagesに公開">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1v6m0 0l2.5-2.5M8 7L5.5 4.5M2 10v3h12v-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        <span>公開</span>
      </button>
    </div>
  </div>

  <div class="split-pane">
    <div class="pane pane-left" id="pane-left">
      <div class="pane-header">
        <div class="pane-tabs">
          <button class="pane-tab active" data-tab="blocks">ブロック一覧</button>
          <button class="pane-tab" data-tab="code">HTML構造</button>
        </div>
      </div>
      <div class="pane-body">
        <div class="tab-content active" id="tab-blocks">
          <div class="block-list" id="block-list"></div>
        </div>
        <div class="tab-content" id="tab-code">
          <div class="code-editor" id="code-editor"></div>
        </div>
      </div>
    </div>
    <div class="split-divider" id="split-divider"><div class="divider-handle"></div></div>
    <div class="pane pane-right" id="pane-right">
      <div class="pane-header">
        <span class="pane-label">プレビュー</span>
        <span class="preview-viewport">412px</span>
      </div>
      <div class="preview-container">
        <iframe id="preview-iframe" sandbox="allow-scripts allow-same-origin"></iframe>
      </div>
    </div>
  </div>

  <!-- 右サイドバー（常時表示アイコン列） -->
  <div id="editor-sidebar" class="editor-sidebar">
    <button class="sidebar-icon" id="sb-deploy" title="公開">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><path d="M8 1v6m0 0l2.5-2.5M8 7L5.5 4.5M2 10v3h12v-3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-history" title="変更履歴">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><path d="M8 4v4l3 2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-fav-widgets" title="お気に入りWidget">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><rect x="2" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="2" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="2" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/><rect x="9" y="9" width="5" height="5" rx="1" stroke="currentColor" stroke-width="1.5"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-link-manage" title="リンク管理">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M2 8h8M2 12h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-tag-settings" title="タグ設定">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><path d="M3 3h10v2H3zM5 7h6v2H5zM4 11h8v2H4z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-undo" title="元に戻す">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><path d="M3 8h8a3 3 0 010 6H9" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M6 5L3 8l3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-redo" title="やり直し">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><path d="M13 8H5a3 3 0 000 6h2" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M10 5l3 3-3 3" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-exit-popup" title="離脱ポップアップ">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><path d="M3 3h10v10H3z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/><path d="M6 8h4M8 6v4" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    </button>
    <button class="sidebar-icon" id="sb-settings" title="設定">
      <svg width="18" height="18" viewBox="0 0 16 16" fill="none"><circle cx="8" cy="8" r="2" stroke="currentColor" stroke-width="1.5"/><path d="M8 1v2M8 13v2M1 8h2M13 8h2M3.05 3.05l1.41 1.41M11.54 11.54l1.41 1.41M3.05 12.95l1.41-1.41M11.54 4.46l1.41-1.41" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    </button>
  </div>
</div>

<!-- Widgetコンテキストメニュー -->
<div id="widget-context-menu" class="widget-context-menu">
  <button class="ctx-item" data-action="openHtmlEditor">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M5 3l-3 5 3 5M11 3l3 5-3 5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>HTML編集</span>
  </button>
  <button class="ctx-item" data-action="openQuickEdit">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M11.5 1.5l3 3L5 14H2v-3z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>クイック編集</span>
  </button>
  <button class="ctx-item" data-action="duplicateBelow">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="5" y="5" width="9" height="9" rx="1.5" stroke="currentColor" stroke-width="1.5"/><path d="M3 11V3h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>すぐ下に複製</span>
  </button>
  <button class="ctx-item" data-action="copyToClipboard">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><rect x="5" y="2" width="8" height="10" rx="1" stroke="currentColor" stroke-width="1.5"/><path d="M3 5v9h8" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
    <span>widgetコピー</span>
  </button>
  <button class="ctx-item danger" data-action="deleteWidget">
    <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M2 4h12M5 4V3a1 1 0 011-1h4a1 1 0 011 1v1M6 7v5M10 7v5" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/><path d="M3 4l1 10h8l1-10" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
    <span>削除する</span>
  </button>
</div>

<!-- クイック編集バー -->
<div id="quick-edit-bar" class="quick-edit-bar" style="display:none">
  <button class="qe-btn" data-cmd="bold" title="太字"><b>B</b></button>
  <button class="qe-btn" data-cmd="underline" title="下線"><u>U</u></button>
  <button class="qe-btn" data-cmd="italic" title="斜体"><i>I</i></button>
  <button class="qe-btn qe-color-btn" id="qe-fore-color" title="文字色" data-action="foreColor"><span class="color-dot" style="background:#ec4899"></span></button>
  <button class="qe-btn qe-color-btn" id="qe-back-color" title="背景色" data-action="backColor"><span class="color-dot" style="background:#ffffff"></span></button>
  <div class="qe-spacer"></div>
  <button class="btn-secondary qe-cancel" id="qe-cancel">キャンセル</button>
  <button class="btn-primary qe-save" id="qe-save">更新</button>
</div>

<!-- 3ペインWidget HTMLエディタ -->
<div id="modal-widget-editor" class="modal fullscreen-modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content modal-fullscreen">
    <div class="we-header">
      <button class="we-back-btn" id="we-back">← 戻る</button>
      <span class="we-description" id="we-description">Widget説明</span>
      <span class="we-category" id="we-category">カテゴリ</span>
      <div class="we-header-actions">
        <button class="btn-secondary" id="we-register">Widgetとして登録</button>
        <button class="btn-secondary" id="we-split-toggle">分割</button>
        <button class="btn-primary" id="we-update">更新</button>
      </div>
    </div>
    <div class="we-body">
      <div class="we-preview-pane" id="we-preview-pane">
        <div class="we-toolbar" id="we-toolbar">
          <button class="we-tool-btn" data-cmd="bold" title="太字"><b>B</b></button>
          <button class="we-tool-btn" data-cmd="underline" title="下線"><u>U</u></button>
          <button class="we-tool-btn" data-cmd="italic" title="斜体"><i>I</i></button>
          <button class="we-tool-btn we-color-btn" data-action="foreColor" title="文字色"><span class="color-dot" style="background:#ec4899"></span></button>
          <button class="we-tool-btn we-color-btn" data-action="backColor" title="背景色"><span class="color-dot" style="background:#ffffff"></span></button>
        </div>
        <iframe id="we-preview-iframe" class="we-preview-iframe"></iframe>
      </div>
      <div class="we-divider we-divider-v" id="we-divider-main"></div>
      <div class="we-code-pane" id="we-code-pane">
        <div class="we-code-section" id="we-html-section">
          <div class="we-code-header">
            <span>HTML(カスタム)</span>
            <button class="we-expand-btn" data-target="html" title="展開">&lt;/&gt;</button>
          </div>
          <div id="we-html-editor" class="we-editor-container"></div>
        </div>
        <div class="we-divider we-divider-h" id="we-divider-code"></div>
        <div class="we-code-section" id="we-css-section">
          <div class="we-code-header">
            <span>CSS(カスタム)</span>
            <button class="we-expand-btn" data-target="css" title="展開">&lt;/&gt;</button>
          </div>
          <div id="we-css-editor" class="we-editor-container"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Widget登録モーダル -->
<div id="modal-widget-register" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width:440px">
    <div class="modal-header">
      <h3>Widgetとして登録</h3>
      <button class="modal-close" data-close-modal="modal-widget-register">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="panel-section">
        <div class="panel-section-title">Widget名 *</div>
        <input type="text" id="wr-name" class="panel-input form-input" placeholder="例: キラキラ見出し">
      </div>
      <div class="panel-section">
        <div class="panel-section-title">アイコン（絵文字）</div>
        <input type="text" id="wr-icon" class="panel-input form-input" placeholder="例: ✨" maxlength="4">
      </div>
      <div class="panel-section">
        <div class="panel-section-title">カテゴリ</div>
        <select id="wr-category" class="form-input">
          <option value="区切り">区切り</option>
          <option value="CTA">CTA</option>
          <option value="装飾">装飾</option>
          <option value="インタラクティブ">インタラクティブ</option>
          <option value="その他">その他</option>
        </select>
      </div>
      <div class="panel-section">
        <div class="panel-section-title">説明</div>
        <input type="text" id="wr-description" class="panel-input form-input" placeholder="Widgetの簡単な説明...">
      </div>
      <div class="panel-section" style="display:flex;align-items:center;gap:10px">
        <label class="toggle-switch">
          <input type="checkbox" id="wr-favorite">
          <span class="toggle-slider"></span>
        </label>
        <span style="font-size:13px;color:var(--text-secondary)">お気に入りに追加</span>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close-modal="modal-widget-register">キャンセル</button>
      <button class="btn-primary" id="btn-widget-register-save">登録</button>
    </div>
  </div>
</div>

<!-- 編集パネル (スライドアウト) -->
<div id="edit-panel" class="edit-panel">
  <div class="edit-panel-header">
    <div class="edit-panel-title">
      <span class="edit-panel-type" id="edit-panel-type">text</span>
      <span>ブロック <span id="edit-panel-index">0</span></span>
    </div>
    <button class="edit-panel-close" id="edit-panel-close">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    </button>
  </div>
  <!-- 編集モード切替 -->
  <div class="edit-mode-toggle">
    <button class="mode-btn active" data-mode="manual">手動編集</button>
    <button class="mode-btn" data-mode="ai">AI編集</button>
    <button class="mode-btn" data-mode="block">ブロック編集</button>
  </div>
  <div class="edit-panel-body" id="edit-panel-body"></div>
</div>

<!-- テキスト一括差し替えモーダル -->
<div id="modal-text-modify" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content modal-lg">
    <div class="modal-header">
      <h3>テキスト一括差し替え</h3>
      <button class="modal-close" data-close-modal="modal-text-modify">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <!-- タブ切り替え -->
      <div class="modal-tabs">
        <button class="modal-tab active" data-modal-tab="tab-bulk-replace">一括置換</button>
        <button class="modal-tab" data-modal-tab="tab-block-text">ブロック別</button>
        <button class="modal-tab" data-modal-tab="tab-find-replace">検索と置換</button>
      </div>

      <!-- タブ1: 一括置換（既存） -->
      <div class="modal-tab-content active" id="tab-bulk-replace">
        <div class="form-section">
          <label class="form-label">直接置換（旧テキスト → 新テキスト）</label>
          <div id="replacements-list" class="replacements-list">
            <div class="replacement-row">
              <input type="text" placeholder="旧テキスト（例：商品名）" class="input-old">
              <span class="arrow">&rarr;</span>
              <input type="text" placeholder="新テキスト" class="input-new">
              <button class="btn-remove-row" title="削除">&times;</button>
            </div>
          </div>
          <button class="btn-add-row" id="btn-add-replacement">+ 行を追加</button>
        </div>
        <div class="form-section">
          <label class="form-label">CTA URL差し替え</label>
          <input type="url" id="cta-url-input" class="form-input" placeholder="新しい遷移先URL...">
        </div>
        <div class="form-section">
          <label class="form-label">検出された頻出キーワード（クリックで追加）</label>
          <div id="frequent-terms" class="frequent-terms"></div>
        </div>
      </div>

      <!-- タブ2: ブロック別テキスト -->
      <div class="modal-tab-content" id="tab-block-text">
        <div class="form-section">
          <label class="form-label">テキストブロック一覧（右側を編集して適用）</label>
          <div class="block-text-list" id="block-text-list"></div>
        </div>
      </div>

      <!-- タブ3: 検索と置換 -->
      <div class="modal-tab-content" id="tab-find-replace">
        <div class="find-replace-section">
          <div class="find-replace-row">
            <label class="form-label" style="min-width:60px;margin:0">検索:</label>
            <input type="text" id="find-input" class="find-replace-input" placeholder="検索テキスト...">
            <span class="find-replace-count" id="find-count">0件</span>
          </div>
          <div class="find-replace-row">
            <label class="form-label" style="min-width:60px;margin:0">置換:</label>
            <input type="text" id="replace-input" class="find-replace-input" placeholder="置換テキスト...">
          </div>
          <div class="find-replace-actions">
            <button class="btn-secondary" id="btn-find-count">マッチ数を確認</button>
            <button class="btn-primary" id="btn-find-replace-all">一括置換</button>
          </div>
          <div id="find-replace-preview" class="form-section" style="margin-top:12px"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close-modal="modal-text-modify">キャンセル</button>
      <button class="btn-primary" id="btn-apply-text-modify">差し替えを適用</button>
    </div>
  </div>
</div>

<!-- 書き出しモーダル -->
<div id="modal-export" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content">
    <div class="modal-header">
      <h3>SB互換HTML書き出し</h3>
      <button class="modal-close" data-close-modal="modal-export">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="validation-section" id="validation-section">
        <h4>SB互換チェック</h4>
        <div id="validation-results"></div>
      </div>
      <div class="export-stats" id="export-stats"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" id="btn-copy-html">クリップボードにコピー</button>
      <button class="btn-primary" id="btn-download-html">
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 2v8m-3-3l3 3 3-3M3 12v1h10v-1" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/></svg>
        HTMLをダウンロード
      </button>
    </div>
  </div>
</div>

<!-- Cloudflare設定モーダル -->
<div id="modal-cloudflare" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width:480px">
    <div class="modal-header">
      <h3>Cloudflare Pages 設定</h3>
      <button class="modal-close" data-close-modal="modal-cloudflare">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="panel-section">
        <div class="panel-section-title">Cloudflare Account ID</div>
        <input type="text" id="cf-account-id" class="panel-input" placeholder="例: a1b2c3d4e5f6...">
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px">
          Workers & Pages → 右サイドバーの「アカウントID」からコピー
        </div>
      </div>
      <div class="panel-section">
        <div class="panel-section-title">Cloudflare API Token</div>
        <input type="password" id="cf-api-token" class="panel-input" placeholder="Cloudflare API トークン">
        <div style="font-size:11px;color:var(--text-muted);margin-top:4px">
          My Profile → API Tokens →「Cloudflare Pages: Edit」権限で作成
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close-modal="modal-cloudflare">キャンセル</button>
      <button class="btn-primary" id="btn-save-cloudflare">保存</button>
    </div>
  </div>
</div>

<!-- 公開結果モーダル -->
<div id="modal-publish-result" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width:480px">
    <div class="modal-header">
      <h3>公開完了</h3>
      <button class="modal-close" data-close-modal="modal-publish-result">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div id="publish-result-body"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close-modal="modal-publish-result">閉じる</button>
      <a href="#" id="btn-open-published" class="btn-primary" target="_blank" rel="noopener">サイトを開く</a>
    </div>
  </div>
</div>

<!-- ウィジェット選択サイドバー -->
<div id="widget-sidebar" class="widget-sidebar">
  <div class="edit-panel-header">
    <div class="edit-panel-title">
      <span class="edit-panel-type">Widget</span>
      <span>ウィジェット挿入</span>
    </div>
    <button class="edit-panel-close" id="widget-sidebar-close">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    </button>
  </div>
  <div class="widget-sidebar-body">
    <div class="widget-insert-pos">
      <label class="form-label">挿入位置</label>
      <select id="widget-insert-position" class="form-input">
        <option value="end">末尾に追加</option>
      </select>
    </div>
    <div id="widget-list" class="widget-list"></div>
  </div>
</div>

<!-- 変更履歴サイドバー -->
<div id="history-sidebar" class="history-sidebar">
  <div class="edit-panel-header">
    <div class="edit-panel-title">
      <span class="edit-panel-type">履歴</span>
      <span>変更履歴</span>
    </div>
    <button class="edit-panel-close" id="history-sidebar-close">
      <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
    </button>
  </div>
  <div class="history-sidebar-controls">
    <select id="history-filter" class="form-input" style="font-size:12px;padding:4px 8px">
      <option value="all">全て</option>
      <option value="edit_block">テキスト編集</option>
      <option value="image">画像変更</option>
      <option value="insert">挿入</option>
      <option value="text_modify">テキスト差替</option>
      <option value="save_point">セーブポイント</option>
      <option value="tag_change">タグ設定</option>
    </select>
  </div>
  <div class="history-sidebar-body">
    <div id="history-list" class="history-list"></div>
  </div>
</div>

<!-- +ブロック追加モーダル -->
<div id="modal-add-block" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content modal-lg">
    <div class="modal-header">
      <h3>ブロック追加</h3>
      <button class="modal-close" data-close-modal="modal-add-block">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="form-section">
        <label class="form-label">挿入位置</label>
        <select id="add-block-position" class="form-input">
          <option value="end">末尾に追加</option>
        </select>
      </div>
      <div class="form-section">
        <label class="form-label">HTML</label>
        <textarea id="add-block-html" class="panel-code" rows="10" placeholder="挿入するHTMLを貼り付け..."></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close-modal="modal-add-block">キャンセル</button>
      <button class="btn-primary" id="btn-insert-block">挿入</button>
    </div>
  </div>
</div>

<!-- タグ設定モーダル -->
<div id="modal-tag-settings" class="modal fullscreen-modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content modal-fullscreen">
    <div class="modal-header">
      <h3>タグ設定</h3>
      <button class="modal-close" data-close-modal="modal-tag-settings">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="tag-settings-layout">
      <div class="tag-settings-nav">
        <button class="tag-nav-btn active" data-tag-section="headTags">HEAD タグ</button>
        <button class="tag-nav-btn" data-tag-section="bodyTags">BODY タグ</button>
        <button class="tag-nav-btn" data-tag-section="noindex">noindex設定</button>
        <button class="tag-nav-btn" data-tag-section="jsHead">JavaScript (HEAD)</button>
        <button class="tag-nav-btn" data-tag-section="jsBody">JavaScript (BODY)</button>
        <button class="tag-nav-btn" data-tag-section="masterCss">Master CSS</button>
      </div>
      <div class="tag-settings-editor">
        <div class="tag-section active" id="tag-section-headTags">
          <div class="tag-section-header">
            <h4>HEADタグ</h4>
            <p>HTMLの&lt;head&gt;内に挿入されるカスタムタグ（meta, link等）</p>
          </div>
          <div class="tag-editor-container" id="tag-editor-headTags"></div>
        </div>
        <div class="tag-section" id="tag-section-bodyTags">
          <div class="tag-section-header">
            <h4>BODYタグ</h4>
            <p>HTMLの&lt;/body&gt;直前に挿入されるカスタムタグ</p>
          </div>
          <div class="tag-editor-container" id="tag-editor-bodyTags"></div>
        </div>
        <div class="tag-section" id="tag-section-noindex">
          <div class="tag-section-header">
            <h4>noindex設定</h4>
            <p>検索エンジンによるインデックスを防止します</p>
          </div>
          <div class="tag-toggle-section">
            <label class="toggle-switch">
              <input type="checkbox" id="tag-noindex-toggle">
              <span class="toggle-slider"></span>
            </label>
            <span class="toggle-label">noindexを有効にする</span>
          </div>
          <div class="tag-noindex-preview">
            <code>&lt;meta name="robots" content="noindex"&gt;</code>
          </div>
        </div>
        <div class="tag-section" id="tag-section-jsHead">
          <div class="tag-section-header">
            <h4>JavaScript (HEAD)</h4>
            <p>HEADに挿入されるJavaScriptコード（トラッキングコード等）</p>
          </div>
          <div class="tag-editor-container" id="tag-editor-jsHead"></div>
        </div>
        <div class="tag-section" id="tag-section-jsBody">
          <div class="tag-section-header">
            <h4>JavaScript (BODY)</h4>
            <p>BODY末尾に挿入されるJavaScriptコード</p>
          </div>
          <div class="tag-editor-container" id="tag-editor-jsBody"></div>
        </div>
        <div class="tag-section" id="tag-section-masterCss">
          <div class="tag-section-header">
            <h4>Master CSS</h4>
            <p>ページ全体に適用されるCSSスタイル</p>
          </div>
          <div class="tag-editor-container" id="tag-editor-masterCss"></div>
        </div>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close-modal="modal-tag-settings">キャンセル</button>
      <button class="btn-primary" id="btn-save-tag-settings">保存</button>
    </div>
  </div>
</div>

<!-- 離脱ポップアップ設定モーダル -->
<div id="modal-exit-popup" class="modal fullscreen-modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content modal-fullscreen">
    <div class="modal-header">
      <h3>離脱ポップアップ設定</h3>
      <button class="modal-close" data-close-modal="modal-exit-popup">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="exit-popup-layout">
      <div class="exit-popup-settings" id="exit-popup-settings">
        <!-- Settings populated by JS -->
      </div>
      <div class="exit-popup-preview-pane">
        <div class="exit-popup-preview-header">ライブプレビュー</div>
        <iframe id="exit-popup-preview-iframe" class="exit-popup-preview-iframe"></iframe>
      </div>
    </div>
    <div class="modal-footer">
      <button class="btn-secondary" data-close-modal="modal-exit-popup">キャンセル</button>
      <button class="btn-primary" id="btn-save-exit-popup">保存</button>
    </div>
  </div>
</div>

<!-- 画像アップロードモーダル -->
<div id="modal-upload-image" class="modal">
  <div class="modal-backdrop"></div>
  <div class="modal-content" style="max-width:560px">
    <div class="modal-header">
      <h3>画像アップロード</h3>
      <button class="modal-close" data-close-modal="modal-upload-image">
        <svg width="20" height="20" viewBox="0 0 20 20" fill="none"><path d="M5 5l10 10M15 5L5 15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
      </button>
    </div>
    <div class="modal-body">
      <div class="upload-modal-zone" id="upload-modal-zone">
        <div class="upload-drop-icon">📁</div>
        <div class="upload-drop-text">画像をドラッグ＆ドロップ<br>またはクリックして選択</div>
        <input type="file" id="upload-modal-file" accept="image/*" style="display:none">
      </div>
      <div id="upload-modal-preview" class="upload-modal-preview" style="display:none">
        <img id="upload-modal-img" style="max-width:100%;border-radius:6px">
        <div class="upload-modal-info" id="upload-modal-info"></div>
      </div>
      <div id="upload-modal-actions" class="upload-modal-actions" style="display:none">
        <div class="form-section">
          <label class="form-label">挿入位置</label>
          <select id="upload-insert-position" class="form-input">
            <option value="end">末尾に追加</option>
          </select>
        </div>
        <button class="btn-primary upload-action-btn" id="btn-upload-insert">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 3v10M3 8h10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/></svg>
          新規画像ブロックとして挿入
        </button>
        <div class="upload-divider"><span>または</span></div>
        <div class="form-section">
          <label class="form-label">参考画像からAI生成</label>
          <div class="upload-ai-options">
            <div class="upload-ai-mode-row">
              <button class="panel-btn primary" data-ref-mode="similar">類似生成</button>
              <button class="panel-btn" data-ref-mode="tonmana">トンマナ変更</button>
              <button class="panel-btn" data-ref-mode="new">新規生成</button>
            </div>
            <div class="upload-ai-style-row">
              <button class="oneclick-radio active" data-ref-style="photo">写真風</button>
              <button class="oneclick-radio" data-ref-style="manga">漫画風</button>
              <button class="oneclick-radio" data-ref-style="illustration">イラスト</button>
              <button class="oneclick-radio" data-ref-style="flat">フラット</button>
            </div>
            <textarea id="upload-ai-prompt" class="panel-textarea" placeholder="追加指示（任意）..." rows="2"></textarea>
          </div>
        </div>
        <button class="btn-primary upload-action-btn" id="btn-upload-ai-gen" style="background:linear-gradient(135deg,#8b5cf6,#ec4899)">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none"><path d="M8 1l1.5 4.5L14 7l-4.5 1.5L8 13l-1.5-4.5L2 7l4.5-1.5z" stroke="currentColor" stroke-width="1.5" stroke-linejoin="round"/></svg>
          参考画像からAI生成
        </button>
        <div id="upload-ai-results" class="oneclick-result-grid"></div>
      </div>
    </div>
  </div>
</div>

<div id="toast-container" class="toast-container"></div>

<script type="module" src="/js/widgets.js"></script>
<script type="module" src="/js/api.js"></script>
<script type="module" src="/js/panels.js"></script>
<script type="module" src="/js/editor.js"></script>
<script type="module" src="/js/tag-settings.js"></script>
<script type="module" src="/js/exit-popup.js"></script>
<script src="/js/codemirror-loader.js"></script>
<script src="/js/color-picker.js"></script>
<script src="/js/widget-editor.js"></script>
<script type="module" src="/js/app.js"></script>
</body>
</html>
